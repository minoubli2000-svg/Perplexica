// main.js - Electron Themis intÃ©grÃ©
const { app, BrowserWindow, Menu, ipcMain, shell } = require('electron');
const { spawn, exec } = require('child_process');
const path = require('path');
const fs = require('fs');

let mainWindow = null;
let servicesProcess = null;
let servicesStarted = false;

// Configuration
const CONFIG = {
  projectPath: __dirname,
  frontendPort: 3000,
  perplexicaPort: 3001,
  backendPort: 5000,
  ollamaPort: 11434
};

// Logs
function log(message, type = 'INFO') {
  const timestamp = new Date().toISOString();
  console.log([] [] );
}

// DÃ©marrage services Docker
function startAllServices() {
  if (servicesStarted) {
    log('Services dÃ©jÃ  dÃ©marrÃ©s');
    return Promise.resolve();
  }

  return new Promise((resolve, reject) => {
    log('ğŸš€ DÃ©marrage des services Docker Themis...');
    
    exec('docker-compose down', { cwd: CONFIG.projectPath }, (error) => {
      if (error) log(ArrÃªt services: , 'WARN');
      
      servicesProcess = spawn('docker-compose', ['up', '-d'], {
        cwd: CONFIG.projectPath,
        stdio: 'pipe',
        shell: true
      });

      servicesProcess.stdout.on('data', (data) => {
        log(Docker: );
      });

      servicesProcess.stderr.on('data', (data) => {
        log(Docker Error: , 'ERROR');
      });

      servicesProcess.on('close', (code) => {
        if (code === 0) {
          log('âœ… Services Docker dÃ©marrÃ©s avec succÃ¨s');
          servicesStarted = true;
          setTimeout(resolve, 15000);
        } else {
          log(âŒ Erreur Docker (code ), 'ERROR');
          reject(new Error(Docker failed with code ));
        }
      });
    });
  });
}

// CrÃ©ation fenÃªtre Themis
function createThemisWindow() {
  log('ğŸ¨ CrÃ©ation de la fenÃªtre Themis...');
  
  mainWindow = new BrowserWindow({
    width: 1400,
    height: 900,
    minWidth: 1200,
    minHeight: 700,
    frame: false,
    titleBarStyle: 'hidden',
    backgroundColor: '#ffffff',
    show: false,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      preload: path.join(__dirname, 'electron', 'preload.js'),
      webSecurity: true
    },
    icon: path.join(__dirname, 'electron', 'assets', 'themis-icon.png')
  });

  const themisUrl = http://localhost:;
  
  mainWindow.loadURL(themisUrl).catch(error => {
    log(âŒ Erreur chargement interface: , 'ERROR');
    mainWindow.loadURL(http://localhost:).catch(() => {
      mainWindow.loadFile(path.join(__dirname, 'electron', 'error.html'));
    });
  });

  mainWindow.once('ready-to-show', () => {
    log('âœ¨ Interface Themis affichÃ©e');
    mainWindow.show();
  });

  mainWindow.webContents.setWindowOpenHandler(({ url }) => {
    if (url.startsWith('http://localhost')) {
      return { action: 'allow' };
    }
    shell.openExternal(url);
    return { action: 'deny' };
  });

  mainWindow.on('closed', () => {
    mainWindow = null;
  });

  return mainWindow;
}

// IPC Handlers
ipcMain.handle('window-minimize', () => {
  if (mainWindow) {
    mainWindow.minimize();
    return true;
  }
  return false;
});

ipcMain.handle('window-maximize', () => {
  if (mainWindow) {
    if (mainWindow.isMaximized()) {
      mainWindow.unmaximize();
    } else {
      mainWindow.maximize();
    }
    return true;
  }
  return false;
});

ipcMain.handle('window-close', () => {
  if (mainWindow) {
    mainWindow.close();
    return true;
  }
  return false;
});

ipcMain.handle('start-all-services', async () => {
  try {
    await startAllServices();
    return { success: true, message: 'Services dÃ©marrÃ©s' };
  } catch (error) {
    return { success: false, message: error.message };
  }
});

ipcMain.handle('get-services-status', async () => {
  return {
    docker: servicesStarted,
    frontend: true,
    backend: servicesStarted,
    perplexica: servicesStarted,
    ollama: servicesStarted
  };
});

// CrÃ©ation raccourci bureau
function createDesktopShortcut() {
  const scriptsDir = path.join(CONFIG.projectPath, 'scripts');
  if (!fs.existsSync(scriptsDir)) {
    fs.mkdirSync(scriptsDir, { recursive: true });
  }

  const startScript = @echo off
title Themis - Demarrage
cd /d ""
echo ğŸ›ï¸ Demarrage Themis...
docker-compose up -d
timeout /t 20 /nobreak >nul
start "" "";

  fs.writeFileSync(path.join(scriptsDir, 'start-themis.bat'), startScript, 'utf8');
  log('ğŸ“ Script de dÃ©marrage crÃ©Ã©');
}

// DÃ©marrage principal
app.whenReady().then(async () => {
  log('âš¡ Electron Themis dÃ©marrÃ©');
  log(ğŸ“ Projet: );

  Menu.setApplicationMenu(null);
  createDesktopShortcut();

  try {
    log('ğŸš€ Lancement des services...');
    await startAllServices();
    setTimeout(() => {
      createThemisWindow();
    }, 5000);
  } catch (error) {
    log(âŒ Erreur dÃ©marrage: , 'ERROR');
    setTimeout(() => {
      createThemisWindow();
    }, 2000);
  }

  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createThemisWindow();
    }
  });
});

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    if (servicesProcess) {
      log('ğŸ›‘ ArrÃªt des services Docker...');
      exec('docker-compose down', { cwd: CONFIG.projectPath }, (error) => {
        if (error) log(Erreur arrÃªt: , 'WARN');
        app.quit();
      });
    } else {
      app.quit();
    }
  }
});

process.on('uncaughtException', (error) => {
  log(ğŸ’¥ Erreur non gÃ©rÃ©e: , 'ERROR');
});

log('ğŸ›ï¸ THEMIS - Application de gestion documentaire avec IA');
